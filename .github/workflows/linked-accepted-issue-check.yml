name: 要求至少一个 accepted 的 Issue

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

permissions:
  contents: read
  pull-requests: read
  issues: read

jobs:
  check-linked-issue:
    runs-on: ubuntu-latest

    steps:
      - name: 检查是否存在 open 且 accepted 的关联 Issue
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // 主路径：使用 GraphQL closingIssuesReferences 获取 PR 当前关联的 Issue。
            const prGraph = await github.graphql(
              `query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $number) {
                    closingIssuesReferences(first: 100) {
                      nodes {
                        number
                      }
                    }
                    userLinkedClosingIssues: closingIssuesReferences(first: 100, userLinkedOnly: true) {
                      nodes {
                        number
                      }
                    }
                  }
                }
              }`,
              {
                owner,
                repo,
                number: pr.number
              }
            );

            const closingIssueNumbers = [
              ...(prGraph.repository?.pullRequest?.closingIssuesReferences?.nodes || []),
              ...(prGraph.repository?.pullRequest?.userLinkedClosingIssues?.nodes || [])
            ]
              .map(node => node?.number)
              .filter(number => Number.isInteger(number));

            const { data: latestPr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: pr.number
            });

            // 兼容 PR 描述中通过 Closes/Fixes/Resolves #123 关联 issue 的场景。
            const body = latestPr.body || "";
            const keywordLinkedIssues = [...new Set(
              [...body.matchAll(/\b(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s*:?\s*#(\d+)\b/gi)]
                .map(match => Number(match[1]))
                .filter(number => Number.isInteger(number))
            )];

            const linkedIssues = [...new Set([
              ...closingIssueNumbers,
              ...keywordLinkedIssues
            ])];

            if (linkedIssues.length === 0) {
              core.setFailed("❌ PR 必须关联至少一个 Issue（请使用 Closes #123）");
              return;
            }

            let valid = false;

            for (const issueNumber of linkedIssues) {
              const { data: issue } = await github.rest.issues.get({
                owner,
                repo,
                issue_number: issueNumber
              });

              // 仅接受普通 Issue，不把 PR 当成 Issue 通过条件。
              if (issue.pull_request) {
                core.info(`跳过 #${issueNumber}：该编号是 Pull Request`);
                continue;
              }

              const hasAccepted = issue.labels.some(label => {
                const labelName = typeof label === "string" ? label : label.name;
                return labelName === "accepted";
              });

              if (issue.state === "open" && hasAccepted) {
                core.info(`✅ Issue #${issueNumber} 是 open 且包含 accepted 标签`);
                valid = true;
                break;
              }

              core.info(
                `Issue #${issueNumber} 不满足条件（state=${issue.state}, accepted=${hasAccepted}）`
              );
            }

            if (!valid) {
              core.setFailed(
                "❌ 所有关联的 Issue 中，没有一个同时满足 open 且包含 'accepted' 标签"
              );
            }
