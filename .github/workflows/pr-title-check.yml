name: PR标题校验

on:
  pull_request:
    types: [opened, edited, reopened]

jobs:
  validate-pr-title:
    if: github.event.action != 'edited' || github.event.changes.title
    name: 校验PR标题
    runs-on: ubuntu-latest
    steps:
      - name: 使用Python校验PR标题
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          python3 - <<'PY'
          import os
          import re
          import sys

          title = (os.getenv("PR_TITLE") or "").strip()
          allowed_types = {
              "build", "chore", "ci", "docs", "feat", "fix",
              "perf", "refactor", "revert", "style", "test", "types"
          }

          match = re.fullmatch(r"([a-z]+)(?:\(([^)]+)\))?: (.+)", title)
          if not match:
              print("PR格式有误，应为type(scope): subject 或 type: subject")
              sys.exit(1)

          pr_type, scope, subject = match.groups()
          if pr_type not in allowed_types or (scope and not re.fullmatch(r"[A-Za-z0-9._/-]+", scope)) or not subject.strip():
              print("PR格式有误，应为type(scope): subject 或 type: subject")
              sys.exit(1)
          PY
