name: PR标题校验

on:
  pull_request:
    types: [opened, edited, reopened]

jobs:
  validate-pr-title:
    name: 校验PR标题
    runs-on: ubuntu-latest
    steps:
      - name: 使用Python校验PR标题
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          python3 - <<'PY'
          import os
          import re
          import sys

          def fail(message: str, detail: str | None = None) -> None:
              print(f"::error title=PR 标题校验失败::{message}")
              if detail:
                  print(detail)
              sys.exit(1)

          title = (os.getenv("PR_TITLE") or "").strip()
          allowed_types = {
              "build", "chore", "ci", "docs", "feat", "fix",
              "perf", "refactor", "revert", "style", "test", "types"
          }

          match = re.match(r"^([a-z]+)(?:\(([^)]+)\))?:(\s+)(.+)$", title)
          if not match:
              fail(
                  "PR 标题格式错误，应为: type(scope): subject 或 type: subject",
                  f"例如: feat(api): add login endpoint\n当前标题: {title}",
              )

          pr_type, scope, spaces_after_colon, subject = match.groups()

          if pr_type not in allowed_types:
              fail(
                  f'不支持的 type: "{pr_type}"',
                  "允许的 type: " + ", ".join(sorted(allowed_types)),
              )

          if spaces_after_colon != " ":
              fail(
                  "格式错误: 冒号后必须有且仅有 1 个空格。",
                  f"正确示例: feat(api): add login endpoint\n当前标题: {title}",
              )

          if scope and not re.fullmatch(r"[A-Za-z0-9._/-]+", scope):
              fail(
                  f'scope 不合法: "{scope}"',
                  "scope 仅允许英文、数字、点(.)、下划线(_) 、斜杠(/) 、中划线(-)",
              )

          if not subject.strip():
              fail("subject 不能为空")

          print(f"PR title OK -> type={pr_type}, scope={scope or '-'}, subject={subject}")
          PY
